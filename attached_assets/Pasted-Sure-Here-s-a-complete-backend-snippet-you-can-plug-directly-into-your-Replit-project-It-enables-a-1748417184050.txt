Sure! Hereâ€™s a complete backend snippet you can plug directly into your Replit project. It enables assigning a user to an organizationâ€”perfect for a multi-tenant clinic system.

â¸»

ðŸŒŸ Complete Express Endpoint

This snippet includes:

âœ… Validation
âœ… Only admins or superadmins can assign users
âœ… Prevents users from assigning themselves

â¸»


// /routes/admin/users.ts

import express from 'express';
import bcrypt from 'bcryptjs';
import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';
import { users, organizations } from '../schema';

const router = express.Router();

// Database connection
const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle(pool);

// Middleware: Only allow admin or superadmin
const requireAdmin = (req, res, next) => {
  if (req.user?.role === 'admin' || req.user?.role === 'superadmin') {
    next();
  } else {
    res.status(403).json({ error: 'Access denied. Admins only.' });
  }
};

// ðŸŸ¦ Create a new user and assign to an organization
router.post('/create', requireAdmin, async (req, res) => {
  const { username, password, email, phone, role, organizationId } = req.body;

  // Basic validation
  if (!username || !password || !organizationId) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  try {
    // Check if organization exists
    const org = await db.select().from(organizations).where(organizations.id.eq(parseInt(organizationId))).then(r => r[0]);
    if (!org) return res.status(400).json({ error: 'Invalid organization ID' });

    // Check if username already exists
    const existingUser = await db.select().from(users).where(users.username.eq(username)).then(r => r[0]);
    if (existingUser) return res.status(400).json({ error: 'Username already exists' });

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Insert new user
    const newUser = await db.insert(users).values({
      username,
      password: hashedPassword,
      email,
      phone,
      role,
      organizationId: parseInt(organizationId)
    }).returning();

    res.json(newUser[0]);
  } catch (error) {
    console.error('Error creating user:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// ðŸŸ¦ Update an existing user's organization
router.patch('/:id/organization', requireAdmin, async (req, res) => {
  const { id } = req.params;
  const { organizationId } = req.body;

  if (!organizationId) return res.status(400).json({ error: 'Organization ID is required' });

  try {
    // Check if organization exists
    const org = await db.select().from(organizations).where(organizations.id.eq(parseInt(organizationId))).then(r => r[0]);
    if (!org) return res.status(400).json({ error: 'Invalid organization ID' });

    // Update user
    const updatedUser = await db.update(users)
      .set({ organizationId: parseInt(organizationId) })
      .where(users.id.eq(parseInt(id)))
      .returning();

    res.json(updatedUser[0]);
  } catch (error) {
    console.error('Error updating user organization:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

export default router;


â¸»

ðŸŒŸ How to Use in Replit

âœ… In your main Express app (server.ts or index.ts):

import adminUserRoutes from './routes/admin/users';

app.use('/api/admin/users', adminUserRoutes);

âœ… Make sure you have these environment variables in Replitâ€™s .env:

DATABASE_URL=your_postgres_db_url
JWT_SECRET=your_jwt_secret_key

âœ… Replitâ€™s console logs will show:
	â€¢	When a user is created
	â€¢	When a userâ€™s organization is updated
	â€¢	Any errors that might occur

â¸»

ðŸŒŸ Test It

âœ… Create User (POST):

POST /api/admin/users/create
{
  "username": "doctor2",
  "password": "securePass123",
  "email": "doctor2@clinic.com",
  "phone": "+2348012345678",
  "role": "doctor",
  "organizationId": 2
}

âœ… Update User Organization (PATCH):

PATCH /api/admin/users/1/organization
{
  "organizationId": 3
}

âœ… Must be authenticated as admin/superadmin (with JWT or session).

â¸»

Would you like me to:

ðŸ”¹ Bundle this into a ready-to-import zip file?
ðŸ”¹ Or show you frontend React examples for how to call these endpoints?
Let me knowâ€”Iâ€™m ready to wrap this up for you! ðŸš€âœ¨