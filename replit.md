# Bluequee - Clinic Management System

## Overview
Bluequee is a comprehensive digital health platform for rural healthcare delivery in Southwest Nigeria. It focuses on advanced medical communication, intelligent lab result analysis, and patient engagement. The platform provides robust, secure, and user-friendly clinic management, patient care, and administrative tools, including patient data, appointments, prescriptions, and secure communication, with an emphasis on security, compliance, and accessibility.

## User Preferences
- Focus on mobile-first responsive design
- Prioritize healthcare-specific functionality
- Maintain clean, professional interface design
- Ensure security and compliance standards

## System Architecture
**UI/UX Decisions:**
The system features a mobile-first responsive design with a clean, professional interface, utilizing Shadcn/UI components and Tailwind CSS. It incorporates a healthcare-card design system, clear UI elements, and WCAG 2.1 compliant accessibility. Color coding is used for visual hierarchy.

**Technical Implementations:**
- **Frontend:** React TypeScript with Wouter for routing.
- **Backend:** Express.js, providing Public REST API and Mobile API with API key authentication.
- **Database:** PostgreSQL managed with Drizzle ORM, utilizing `pg_trgm` for fuzzy search.
- **State Management:** TanStack Query.
- **Authentication:** Replit Auth (OpenID Connect for social logins) and custom username/password, with robust security middleware (password validation, login attempt tracking, session management).
- **Security Headers:** Comprehensive middleware for CSP, X-Content-Type-Options, X-Frame-Options, X-XSS-Protection, Referrer-Policy, and Permissions-Policy. HSTS enabled in production.
- **API System:** Public REST API (`/api/v1/*`) and Mobile API (`/api/mobile/*`) with API Key Management, OpenAPI/Swagger Documentation, configurable permissions, and rate limiting.
- **Help & Support:** Comprehensive system with FAQs, guides, and contact forms.
- **System Design Choices:** Multi-tenant support, modular Express Router architecture.

**Feature Specifications:**
- **Enhanced Blood Test Dashboard:** 4-tab interface with interactive charts (recharts), clinical trend analysis, and mobile responsiveness.
- **Enhanced Medication Management:** Visual categorization, refill tracking, alerts, and touch-friendly mobile controls.
- **Typo-Tolerant Medication Search:** Fuzzy text search using PostgreSQL `pg_trgm` for medication suggestions.
- **User Management System:** Role-based user creation, permission-based access control, organization-aware operations, and audit logging.
- **Patient Management:** Redesigned interface with streamlined controls, search, filters, and sorting.
- **Patient Portal:** Secure, mobile-responsive portal for patient authentication, dashboard, lab results, medications, and appointments.
- **Staff Access Control System:** Comprehensive RBAC with 63+ granular permissions, role management UI, and audit logging. Supports multi-admin roles.
- **Multi-Organization Membership:** Users can belong to multiple organizations with a selection on login and in-session switching.
- **Compliance & Export Reports:** Real-time generation of 6 report types (Excel, PDF, CSV, XML) for regulatory compliance and data exports, with date range filtering and category filtering.
- **UI Component Showcase:** Interactive `/ui-showcase` page for testing UI components, including 10 tabbed sections and automated testing for 25 UI/CRUD operations.
- **AI-Powered Consultation Tool (Enhanced):** Uses GPT-4o (via Replit AI Integrations) for context-aware patient simulations and intelligent SOAP note generation. Features include differential diagnoses, ICD-10 auto-coding, lab test suggestions, clinical safety warnings, confidence scoring, and follow-up intelligence.
- **Laboratory Orders System (Enhanced):** Comprehensive laboratory management system with AI-powered test suggestions, standardized test catalog, and common panel groupings optimized for rural Nigerian healthcare delivery. System enables rapid ordering of common test panels, intelligent AI-driven test recommendations based on clinical presentation, and maintains a curated catalog of essential laboratory tests with LOINC standardization. **(1) Lab Test Catalog:** Global shared catalog of 109 essential lab tests organized across 8 clinical departments: Hematology (CBC components: Hemoglobin 12-16 g/dL, WBC 4000-11000/μL, Platelets 150000-450000/μL, RBC, Hematocrit, MCV, MCH, MCHC, RDW, Differential counts), Chemistry (Glucose 70-100 mg/dL, Creatinine 0.6-1.2 mg/dL, BUN 7-20 mg/dL, Sodium 135-145 mEq/L, Potassium 3.5-5.0 mEq/L, Chloride, Bicarbonate, Calcium, Magnesium, Phosphorus), Microbiology (Malaria Parasite, Blood Culture, Urine Culture, Stool Culture, Sputum Culture, Gram Stain), Immunology (HIV Screening, Hepatitis B Surface Antigen, Hepatitis C Antibody, Rheumatoid Factor, ANA), Molecular (HIV Viral Load, HBV DNA, HCV RNA), Serology (Typhoid Widal, VDRL, Dengue NS1), Urinalysis (Physical examination, Chemical analysis, Microscopy), Coagulation (PT/INR, aPTT, Fibrinogen, D-Dimer). Each test includes LOINC code for standardization, reference ranges with units, specimen type (blood/urine/stool), preparation instructions, estimated turnaround time, and cost in Naira. Example: Hemoglobin (HGB, LOINC 718-7) - Whole Blood EDTA, No preparation required, 2-4 hours, ₦500. **(2) Lab Panels:** 12 pre-configured panel groupings for one-click ordering with automatic test inclusion, cost aggregation, and preparation consolidation. Panels: CBC (11 tests: Hemoglobin, WBC, RBC, Hematocrit, MCV, MCH, MCHC, RDW, Platelets, Neutrophils, Lymphocytes - ₦5500, 4-6 hours), BMP (8 tests: Glucose, Sodium, Potassium, Chloride, Bicarbonate, BUN, Creatinine, Calcium - ₦6400, 4-6 hours), CMP (14 tests: all BMP + Albumin, Total Protein, ALT, AST, ALP, Bilirubin - ₦10200, 4-6 hours), Lipid Panel (5 tests: Total Cholesterol, HDL, LDL, Triglycerides, VLDL - ₦4500, 12 hours fasting required), Liver Function (8 tests: ALT, AST, ALP, GGT, Total Bilirubin, Direct Bilirubin, Albumin, Total Protein - ₦6400), Thyroid Function (4 tests: TSH, Free T4, Free T3, Total T3 - ₦8000), Kidney Function (6 tests: Creatinine, BUN, eGFR, Sodium, Potassium, Uric Acid - ₦5100), Coagulation Panel (4 tests: PT/INR, aPTT, Fibrinogen, D-Dimer - ₦7200), Diabetes Panel (4 tests: Fasting Glucose, HbA1c, Microalbumin, Insulin - ₦6800), Anemia Panel (7 tests: Hemoglobin, Ferritin, Iron, TIBC, B12, Folate, Reticulocyte - ₦8500), Cardiac Panel (5 tests: Troponin I, CK-MB, LDH, Myoglobin, BNP - ₦12000), Infectious Disease Panel (6 tests: Malaria, HIV, Hepatitis B, Hepatitis C, Typhoid, VDRL - ₦9500). Panel data stored in `lab_panels` table with category classification (hematology/chemistry/panel), estimated time, sample type, and organization-specific availability. **(3) AI-Powered Test Suggestions:** GPT-4o-based intelligent recommendation engine that analyzes clinical context (symptoms, diagnosis, patient age/gender, medical history, current medications, recent lab results) and returns prioritized test suggestions from available catalog. AI prompt embeds full test catalog with names, codes, categories, and descriptions; instructs model to consider cost-effectiveness, diagnostic yield, Nigerian healthcare context, and urgency (routine/urgent/stat). Response format: JSON with suggestions array containing testName, testCode, loincCode, category, reasoning (clinical justification), urgency level, priority score (1=highest, 10=lowest), clinicalSignificance (what test helps diagnose or rule out). Post-processing matches AI output to actual catalog tests by name/code (case-insensitive), filters out unmatched suggestions, and returns only validated entries with testId, ensuring all returned suggestions correspond to orderable tests. Model: GPT-4o, temperature 0.4 (balanced), max tokens 1500. Example query: symptoms="frequent urination, increased thirst, fatigue"&diagnosis="suspected diabetes" returns Fasting Glucose (priority 1, urgent, "Essential for diabetes diagnosis"), HbA1c (priority 2, routine, "Assess long-term glucose control"), Microalbumin (priority 4, routine, "Screen for diabetic kidney disease"). Endpoint accepts optional patientId to fetch patient demographics (age, gender, medical history) for personalized recommendations. **(4) Database Schema:** `lab_tests` (id serial PK, name varchar(100), code varchar(50) test code, loincCode varchar(50) LOINC standard, category varchar(50), description varchar(255), units varchar(50), referenceRange varchar(100), departmentId int FK, organizationId int FK nullable for global catalog, isActive boolean, priority varchar(20) default routine, sampleType varchar(50), methodOfCollection varchar(100), preparationInstructions text, estimatedTime varchar(50), cost decimal(10,2), createdAt timestamp); `lab_departments` (id serial PK, name varchar(100), code varchar(50), description text, isActive boolean, createdAt timestamp); `lab_panels` (id serial PK, name varchar(100), code varchar(50), description text, category varchar(50) hematology/chemistry/panel, totalCost decimal(10,2), estimatedTime varchar(50), sampleType varchar(50), preparationInstructions text, isCommon boolean flag common panels, isActive boolean, departmentId int FK nullable, organizationId int FK nullable for global panels, createdAt timestamp); `lab_panel_tests` (id serial PK, panelId int FK lab_panels, testId int FK lab_tests, isRequired boolean, displayOrder int for UI sorting). Existing `lab_orders`, `lab_order_items`, `lab_results` tables unchanged. **(5) Backend API:** Modular route files `server/routes/lab-panels.ts` (panel and AI endpoints) and `server/routes/lab-seed.ts` (catalog seeding). Endpoints: GET `/api/lab-panels?category=hematology&isCommon=true` returns panel list with department names, filtered by category and commonality, organization-scoped; GET `/api/lab-panels/:id` returns panel details with associated tests array (testId, name, code, loincCode, category, units, referenceRange, cost, isRequired, displayOrder), preparation instructions, total cost, organization-scoped; POST `/api/lab-orders/from-panel` body {patientId, panelId, clinicalNotes, diagnosis, priority} creates lab order with all panel tests as order items, calculates total cost from panel or sums test costs, organization-scoped; GET `/api/lab-tests/ai-suggest?symptoms=...&diagnosis=...&patientId=...` returns {suggestions: [{testId, testName, testCode, loincCode, category, reasoning, urgency, priority, clinicalSignificance, estimatedCost}], totalSuggestions, catalogSize}, validates suggestions against catalog, organization-scoped with global catalog support; POST `/api/lab/seed?force=true` body {} seeds 8 departments, 109 tests, 12 panels, 80 panel-test associations, admin-only, idempotent unless force flag. All endpoints use authenticateToken + tenantMiddleware, extract organizationId from req.tenant.id with fallback, return 403 if organization context missing, return 400 for validation errors, return 404 for not found, return 500 for server errors. **(6) Multi-Tenant Security:** All endpoints enforce proper tenant isolation. Lab panels filtered by AND(isActive=true, OR(organizationId IS NULL, organizationId=currentOrgId)) to support global panels plus org-specific panels. AI test catalog query uses same OR filter to include both global standard tests (organizationId=NULL) and organization-specific custom tests. Patient data queries filtered by AND(patientId=id, organizationId=currentOrgId) preventing cross-tenant access. Panel order creation validates panel belongs to current organization before creating order. AI suggestions post-validated against filtered catalog, rejecting any tests not accessible to current organization. No undefined testIds returned - all suggestions guaranteed to map to orderable catalog entries. **(7) Usage Workflow:** Seeding: Admin calls POST /api/lab/seed to populate catalog (one-time). Panel Ordering: Provider calls GET /api/lab-panels to browse, selects panel (e.g., CBC), calls POST /api/lab-orders/from-panel with patientId and panelId, system auto-creates order with 11 CBC tests. AI Ordering: Provider calls GET /api/lab-tests/ai-suggest with clinical presentation, reviews AI suggestions with reasoning, selects relevant tests, creates order via existing /api/lab-orders endpoint. Custom Catalog: Organization can INSERT lab_tests with their organizationId for clinic-specific tests (e.g., specialized assays). Frontend integration: Lab order form fetches panels via GET /api/lab-panels, displays as quick-select cards, fetches AI suggestions on symptom input, displays with clinical reasoning badges.

## External Dependencies
- **Replit Auth:** OpenID Connect for social logins.
- **OpenAI:** For AI features via Replit AI Integrations.
- **PostgreSQL:** Relational database with `pg_trgm` extension.
- **Drizzle ORM:** Database interaction.
- **Shadcn/UI:** UI component library.
- **Tailwind CSS:** CSS framework.
- **TanStack Query:** Data fetching and state management.
- **Wouter:** React router.
- **Express.js:** Backend web framework.
- **Passport.js:** Authentication middleware.
- **connect-pg-simple:** PostgreSQL session store.
- **recharts:** React charting library.